# PMS Statistics
# Seems to be a perfomance hit
# - platform: plex
#   host: !secret pms_host
#   port: !secret pms_port
#   name: !secret pms_name
#   username: !secret plex_username
#   password: !secret plex_password
#   server: !secret pms_server

# Home Assistant Version
- platform: version
  source: local
- platform: version
  source: docker

# Home Assistant Uptime
- platform: uptime
  unit_of_measurement: minutes

# Sonarr
- platform: sonarr_upcoming_media
  api_key: !secret sonarr_api_key
  host: !secret sonarr_host
  port: !secret sonarr_port
  days: 7
  max: 10

# Tautulli
- platform: tautulli
  api_key: !secret tautulli_api_key
  host: !secret tautulli_host
  monitored_conditions:
    - friendly_name
    - full_title
    - progress_percent
    - stream_video_resolution
    - transcode_decision
    - user_thumb
    - video_resolution

# Time & Date
- platform: time_date
  display_options:
    - time
    - date

# Dark Sky Weather
- platform: darksky
  api_key: !secret darksky_api_key
  latitude: !secret home_latitude
  longitude: !secret home_longitude
  forecast:
    - 0
  monitored_conditions:
    - summary
    - icon
    - precip_probability
    - temperature
    - humidity
    - minutely_summary
    - hourly_summary
    - daily_summary
    - temperature_high
    - temperature_low
    - sunrise_time
    - sunset_time
    - nearest_storm_distance
  scan_interval:
    minutes: 5

# Peloton
# - platform: peloton
#   username: !secret peloton_username
#   password: !secret peloton_password

# Places
- platform: places
  name: Octavia
  devicetracker_id: device_tracker.beacon_octavia
  home_zone: zone.home
  api_key: !secret places_api_key

- platform: places
  name: Alex
  devicetracker_id: device_tracker.alexs_iphone_geofency
  home_zone: zone.home
  api_key: !secret places_api_key

# Custom sensors for UI display
- platform: min_max
  name: 'Average Temperature'
  type: mean
  entity_ids:
    - sensor.downstairs_thermostat_temperature
    - sensor.upstairs_thermostat_temperature
  round_digits: 1

- platform: min_max
  name: 'Average Humidity'
  type: mean
  entity_ids:
    - sensor.downstairs_thermostat_humidity
    - sensor.upstairs_thermostat_humidity
  round_digits: 1

- platform: template
  sensors:
    bedroom_presence:
      friendly_name: 'Bedroom Presence'
      entity_id: device_tracker.beacon_bedroom
      value_template: >
        {% if is_state('device_tracker.beacon_bedroom', 'bedroom') %}
          occupied
        {% else %}
          unoccupied
        {% endif %}
    august_front_door:
      friendly_name: 'Front Door'
      entity_id: lock.august_smart_lock_pro_front_door
      value_template: >
        {{ states.lock.august_smart_lock_pro_front_door.state }}
      icon_template: >
        {% if is_state('lock.august_smart_lock_pro_front_door', 'locked') %}
          mdi:lock
        {% elif is_state('lock.august_smart_lock_pro_front_door', 'unlocked') %}
          mdi:lock-open
        {% else %}
          mdi:timer-sand
        {% endif %}
    august_garage_door:
      friendly_name: 'Garage Door'
      entity_id: lock.august_smart_lock_pro_garage_door
      value_template: >
        {{ states.lock.august_smart_lock_pro_garage_door.state }}
      icon_template: >
        {% if is_state('lock.august_smart_lock_pro_garage_door', 'locked') %}
          mdi:lock
        {% elif is_state('lock.august_smart_lock_pro_garage_door', 'unlocked') %}
          mdi:lock-open
        {% else %}
          mdi:timer-sand
        {% endif %}
    garage_actual:
      friendly_name: 'Garage Actual'
      entity_id: binary_sensor.garage_actual
      value_template: >
        {% if is_state('binary_sensor.garage_actual', 'off') %}
          closed
        {% elif is_state('binary_sensor.garage_actual', 'on') %}
          open
        {% else %}
          unknown
        {% endif %}
      icon_template: >
        {% if is_state('binary_sensor.garage_actual', 'off') %}
          mdi:garage
        {% elif is_state('binary_sensor.garage_actual', 'on') %}
          mdi:garage-open
        {% else %}
          mdi:timer-sand
        {% endif %}


# Custom sensors for mode monitoring
- platform: template
  sensors:
    mode_morning:
      friendly_name: 'Morning Mode'
      entity_id: input_boolean.mode_morning
      value_template: >
        {{ states('input_boolean.mode_morning') }}
      icon_template: 'mdi:weather-hazy'
    mode_day:
      friendly_name: 'Day Mode'
      entity_id: input_boolean.mode_day
      value_template: >
        {{ states('input_boolean.mode_day') }}
      icon_template: 'mdi:weather-sunny'
    mode_sunset:
      friendly_name: 'Sunset Mode'
      entity_id: input_boolean.mode_sunset
      value_template: >
        {{ states('input_boolean.mode_sunset') }}
      icon_template: 'mdi:weather-sunset'
    mode_night:
      friendly_name: 'Night Mode'
      entity_id: input_boolean.mode_night
      value_template: >
        {{ states('input_boolean.mode_night') }}
      icon_template: 'mdi:weather-night'
    mode_guest:
      friendly_name: 'Guest Mode'
      entity_id: input_boolean.mode_guest
      value_template: >
        {{ states('input_boolean.mode_guest') }}
      icon_template: 'mdi:human-greeting'
    mode_home_theater:
      friendly_name: 'Home Theater Mode'
      entity_id: input_boolean.mode_home_theater
      value_template: >
        {{ states('input_boolean.mode_home_theater') }}
      icon_template: 'mdi:theater'
    mode_sleep:
      friendly_name: 'Sleep Mode'
      entity_id: input_boolean.mode_sleep
      value_template: >
        {{ states('input_boolean.mode_sleep') }}
      icon_template: 'mdi:sleep'
    mode_simulate_presence:
      friendly_name: 'Simulate Presence Mode'
      entity_id:
        - input_boolean.mode_simulate_presence
        - group.all_lights
      value_template: >
        {% if is_state('input_boolean.mode_simulate_presence', 'on') %}
          {% if is_state("group.all_lights", "on") %}
            Lights On
          {% else %}
            Lights Off
          {% endif %}
        {% else %}
          off
        {% endif %}


# Battery sensors
- platform: template
  sensors:
    battery_august_front_door:
      friendly_name: 'August - Front Door'
      entity_id: zwave.august_smart_lock_pro_front_door
      unit_of_measurement: '%'
      value_template: >
        {{ states.zwave.august_smart_lock_pro_front_door.attributes.battery_level }}
      icon_template: >
        {% if states.zwave.august_smart_lock_pro_front_door.attributes.battery_level is defined %}
          {% set level = states.zwave.august_smart_lock_pro_front_door.attributes.battery_level %}
          {% if level | float == 100 %}
            mdi:battery
          {% elif level | float < 10 %}
            mdi:battery-outline
          {% else %}
            {% set icon_level = (level / 10) | int * 10 %}
            mdi:battery-{{ icon_level }}
          {% endif %}
        {% else %}
          mdi:battery-alert
        {% endif %}
    dashboard_battery_august_front_door:
      friendly_name: 'August - Front Door'
      entity_id: sensor.battery_august_front_door
      value_template: >-
        {% if states.sensor.battery_august_front_door.state | int <= 50 %}
          on
        {% else %}
          off
        {% endif %}

    battery_august_front_door_keypad:
      friendly_name: 'August - Front Door Keypad'
      entity_id: sensor.august_web_front_door_keypad_battery
      unit_of_measurement: '%'
      value_template: >
        {{ states.sensor.august_web_front_door_keypad_battery.state }}
      icon_template: >
        {% if states.sensor.august_web_front_door_keypad_battery.state is defined %}
          {% set level = states.sensor.august_web_front_door_keypad_battery.state | int %}
          {% if level | float == 100 %}
            mdi:battery
          {% elif level | float < 10 %}
            mdi:battery-outline
          {% else %}
            {% set icon_level = (level / 10) | int * 10 %}
            mdi:battery-{{ icon_level }}
          {% endif %}
        {% else %}
          mdi:battery-alert
        {% endif %}
    dashboard_battery_august_front_door_keypad:
      friendly_name: 'August - Front Door Keypad'
      entity_id: sensor.battery_august_front_door_keypad
      value_template: >-
        {% if states.sensor.battery_august_front_door_keypad.state | int <= 50 %}
          on
        {% else %}
          off
        {% endif %}

    battery_august_garage_door:
      friendly_name: 'August - Garage Door'
      entity_id: zwave.august_smart_lock_pro_garage_door
      unit_of_measurement: '%'
      value_template: >
        {{ states.zwave.august_smart_lock_pro_garage_door.attributes.battery_level }}
      icon_template: >
        {% if states.zwave.august_smart_lock_pro_garage_door.attributes.battery_level is defined %}
          {% set level = states.zwave.august_smart_lock_pro_garage_door.attributes.battery_level %}
          {% if level | float == 100 %}
            mdi:battery
          {% elif level | float < 10 %}
            mdi:battery-outline
          {% else %}
            {% set icon_level = (level / 10) | int * 10 %}
            mdi:battery-{{ icon_level }}
          {% endif %}
        {% else %}
          mdi:battery-alert
        {% endif %}
    dashboard_battery_august_garage_door:
      friendly_name: 'August - Garage Door'
      entity_id: sensor.battery_august_garage_door
      value_template: >-
        {% if states.sensor.battery_august_garage_door.state | int <= 50 %}
          on
        {% else %}
          off
        {% endif %}

    battery_bedroom_closet_door_sensor:
      friendly_name: 'Bedroom Closet Door Sensor'
      entity_id: zwave.bedroom_closet_door_sensor
      unit_of_measurement: '%'
      value_template: >
        {{ states.zwave.bedroom_closet_door_sensor.attributes.battery_level }}
      icon_template: >
        {% if states.zwave.bedroom_closet_door_sensor.attributes.battery_level is defined %}
          {% set level = states.zwave.bedroom_closet_door_sensor.attributes.battery_level %}
          {% if level | float == 100 %}
            mdi:battery
          {% elif level | float < 10 %}
            mdi:battery-outline
          {% else %}
            {% set icon_level = (level / 10) | int * 10 %}
            mdi:battery-{{ icon_level }}
          {% endif %}
        {% else %}
          mdi:battery-alert
        {% endif %}
    dashboard_battery_bedroom_closet_door_sensor:
      friendly_name: 'Bedroom Closet Door Sensor'
      entity_id: sensor.battery_bedroom_closet_door_sensor
      value_template: >-
        {% if states.sensor.battery_bedroom_closet_door_sensor.state | int <= 50 %}
          on
        {% else %}
          off
        {% endif %}

    battery_den_multisensor:
      friendly_name: 'Den MultiSensor'
      entity_id: zwave.den_multisensor
      unit_of_measurement: '%'
      value_template: >
        {{ states.zwave.den_multisensor.attributes.battery_level }}
      icon_template: >
        {% if states.zwave.den_multisensor.attributes.battery_level is defined %}
          {% set level = states.zwave.den_multisensor.attributes.battery_level %}
          {% if level | float == 100 %}
            mdi:battery
          {% elif level | float < 10 %}
            mdi:battery-outline
          {% else %}
            {% set icon_level = (level / 10) | int * 10 %}
            mdi:battery-{{ icon_level }}
          {% endif %}
        {% else %}
          mdi:battery-alert
        {% endif %}
    dashboard_battery_den_multisensor:
      friendly_name: 'Den MultiSensor'
      entity_id: sensor.battery_den_multisensor
      value_template: >-
        {% if states.sensor.battery_den_multisensor.state | int <= 50 %}
          on
        {% else %}
          off
        {% endif %}

    battery_bedroom_closet_trisensor:
      friendly_name: 'Bedroom Closet TriSensor'
      entity_id: zwave.bedroom_closet_trisensor
      unit_of_measurement: '%'
      value_template: >
        {{ states.zwave.bedroom_closet_trisensor.attributes.battery_level }}
      icon_template: >
        {% if states.zwave.bedroom_closet_trisensor.attributes.battery_level is defined %}
          {% set level = states.zwave.bedroom_closet_trisensor.attributes.battery_level %}
          {% if level | float == 100 %}
            mdi:battery
          {% elif level | float < 10 %}
            mdi:battery-outline
          {% else %}
            {% set icon_level = (level / 10) | int * 10 %}
            mdi:battery-{{ icon_level }}
          {% endif %}
        {% else %}
          mdi:battery-alert
        {% endif %}
    dashboard_battery_bedroom_closet_trisensor:
      friendly_name: 'Bedroom Closet TriSensor'
      entity_id: sensor.battery_bedroom_closet_trisensor
      value_template: >-
        {% if states.sensor.battery_bedroom_closet_trisensor.state | int <= 50 %}
          on
        {% else %}
          off
        {% endif %}

    battery_downstairs_hallway_multisensor:
      friendly_name: 'Downstairs Hallway MultiSensor'
      entity_id: zwave.downstairs_hallway_multisensor
      unit_of_measurement: '%'
      value_template: >
        {{ states.zwave.downstairs_hallway_multisensor.attributes.battery_level }}
      icon_template: >
        {% if states.zwave.downstairs_hallway_multisensor.attributes.battery_level is defined %}
          {% set level = states.zwave.downstairs_hallway_multisensor.attributes.battery_level %}
          {% if level | float == 100 %}
            mdi:battery
          {% elif level | float < 10 %}
            mdi:battery-outline
          {% else %}
            {% set icon_level = (level / 10) | int * 10 %}
            mdi:battery-{{ icon_level }}
          {% endif %}
        {% else %}
          mdi:battery-alert
        {% endif %}
    dashboard_battery_downstairs_hallway_multisensor:
      friendly_name: 'Downstairs Hallway MultiSensor'
      entity_id: sensor.battery_downstairs_hallway_multisensor
      value_template: >-
        {% if states.sensor.battery_downstairs_hallway_multisensor.state | int <= 50 %}
          on
        {% else %}
          off
        {% endif %}

    battery_garage_motion_sensor:
      friendly_name: 'Garage Motion Sensor'
      entity_id: zwave.garage_motion_sensor
      unit_of_measurement: '%'
      value_template: >
        {{ states.zwave.garage_motion_sensor.attributes.battery_level }}
      icon_template: >
        {% if states.zwave.garage_motion_sensor.attributes.battery_level is defined %}
          {% set level = states.zwave.garage_motion_sensor.attributes.battery_level %}
          {% if level | float == 100 %}
            mdi:battery
          {% elif level | float < 10 %}
            mdi:battery-outline
          {% else %}
            {% set icon_level = (level / 10) | int * 10 %}
            mdi:battery-{{ icon_level }}
          {% endif %}
        {% else %}
          mdi:battery-alert
        {% endif %}
    dashboard_battery_garage_motion_sensor:
      friendly_name: 'Garage Motion Sensor'
      entity_id: sensor.battery_garage_motion_sensor
      value_template: >-
        {% if states.sensor.battery_garage_motion_sensor.state | int <= 50 %}
          on
        {% else %}
          off
        {% endif %}

    battery_garage_stairs_multisensor:
      friendly_name: 'Garage Stairs MultiSensor'
      entity_id: zwave.garage_stairs_multisensor
      unit_of_measurement: '%'
      value_template: >
        {{ states.zwave.garage_stairs_multisensor.attributes.battery_level }}
      icon_template: >
        {% if states.zwave.garage_stairs_multisensor.attributes.battery_level is defined %}
          {% set level = states.zwave.garage_stairs_multisensor.attributes.battery_level %}
          {% if level | float == 100 %}
            mdi:battery
          {% elif level | float < 10 %}
            mdi:battery-outline
          {% else %}
            {% set icon_level = (level / 10) | int * 10 %}
            mdi:battery-{{ icon_level }}
          {% endif %}
        {% else %}
          mdi:battery-alert
        {% endif %}
    dashboard_battery_garage_stairs_multisensor:
      friendly_name: 'Garage Stairs MultiSensor'
      entity_id: sensor.battery_garage_stairs_multisensor
      value_template: >-
        {% if states.sensor.battery_garage_stairs_multisensor.state | int <= 50 %}
          on
        {% else %}
          off
        {% endif %}

    battery_guest_bedroom_closet_door_sensor:
      friendly_name: 'Guest Bedroom Closet Door Sensor'
      entity_id: zwave.guest_bedroom_closet_door_sensor
      unit_of_measurement: '%'
      value_template: >
        {{ states.zwave.guest_bedroom_closet_door_sensor.attributes.battery_level }}
      icon_template: >
        {% if states.zwave.guest_bedroom_closet_door_sensor.attributes.battery_level is defined %}
          {% set level = states.zwave.guest_bedroom_closet_door_sensor.attributes.battery_level %}
          {% if level | float == 100 %}
            mdi:battery
          {% elif level | float < 10 %}
            mdi:battery-outline
          {% else %}
            {% set icon_level = (level / 10) | int * 10 %}
            mdi:battery-{{ icon_level }}
          {% endif %}
        {% else %}
          mdi:battery-alert
        {% endif %}
    dashboard_battery_guest_bedroom_closet_door_sensor:
      friendly_name: 'Guest Bedroom Closet Door Sensor'
      entity_id: sensor.battery_guest_bedroom_closet_door_sensor
      value_template: >-
        {% if states.sensor.battery_guest_bedroom_closet_door_sensor.state | int <= 50 %}
          on
        {% else %}
          off
        {% endif %}

    battery_laundry_door_left_sensor:
      friendly_name: 'Laundry Door Left Sensor'
      entity_id: zwave.laundry_door_left_sensor
      unit_of_measurement: '%'
      value_template: >
        {{ states.zwave.laundry_door_left_sensor.attributes.battery_level }}
      icon_template: >
        {% if states.zwave.laundry_door_left_sensor.attributes.battery_level is defined %}
          {% set level = states.zwave.laundry_door_left_sensor.attributes.battery_level %}
          {% if level | float == 100 %}
            mdi:battery
          {% elif level | float < 10 %}
            mdi:battery-outline
          {% else %}
            {% set icon_level = (level / 10) | int * 10 %}
            mdi:battery-{{ icon_level }}
          {% endif %}
        {% else %}
          mdi:battery-alert
        {% endif %}
    dashboard_battery_laundry_door_left_sensor:
      friendly_name: 'Laundry Door Left Sensor'
      entity_id: sensor.battery_laundry_door_left_sensor
      value_template: >-
        {% if states.sensor.battery_laundry_door_left_sensor.state | int <= 50 %}
          on
        {% else %}
          off
        {% endif %}

    battery_laundry_door_right_sensor:
      friendly_name: 'Laundry Door Right Sensor'
      entity_id: zwave.laundry_door_right_sensor
      unit_of_measurement: '%'
      value_template: >
        {{ states.zwave.laundry_door_right_sensor.attributes.battery_level }}
      icon_template: >
        {% if states.zwave.laundry_door_right_sensor.attributes.battery_level is defined %}
          {% set level = states.zwave.laundry_door_right_sensor.attributes.battery_level %}
          {% if level | float == 100 %}
            mdi:battery
          {% elif level | float < 10 %}
            mdi:battery-outline
          {% else %}
            {% set icon_level = (level / 10) | int * 10 %}
            mdi:battery-{{ icon_level }}
          {% endif %}
        {% else %}
          mdi:battery-alert
        {% endif %}
    dashboard_battery_laundry_door_right_sensor:
      friendly_name: 'Laundry Door Right Sensor'
      entity_id: sensor.battery_laundry_door_right_sensor
      value_template: >-
        {% if states.sensor.battery_laundry_door_right_sensor.state | int <= 50 %}
          on
        {% else %}
          off
        {% endif %}

    battery_main_stairs_multisensor:
      friendly_name: 'Main Stairs MultiSensor'
      entity_id: zwave.main_stairs_multisensor
      unit_of_measurement: '%'
      value_template: >
        {{ states.zwave.main_stairs_multisensor.attributes.battery_level }}
      icon_template: >
        {% if states.zwave.main_stairs_multisensor.attributes.battery_level is defined %}
          {% set level = states.zwave.main_stairs_multisensor.attributes.battery_level %}
          {% if level | float == 100 %}
            mdi:battery
          {% elif level | float < 10 %}
            mdi:battery-outline
          {% else %}
            {% set icon_level = (level / 10) | int * 10 %}
            mdi:battery-{{ icon_level }}
          {% endif %}
        {% else %}
          mdi:battery-alert
        {% endif %}
    dashboard_battery_main_stairs_multisensor:
      friendly_name: 'Main Stairs MultiSensor'
      entity_id: sensor.battery_main_stairs_multisensor
      value_template: >-
        {% if states.sensor.battery_main_stairs_multisensor.state | int <= 50 %}
          on
        {% else %}
          off
        {% endif %}

    battery_server_rack_ups:
      friendly_name: 'Server Rack UPS'
      entity_id: sensor.server_rack_ups_battery_charge
      unit_of_measurement: '%'
      value_template: >
        {{ states.sensor.server_rack_ups_battery_charge.state }}
      icon_template: >
        {% if states.sensor.server_rack_ups_battery_charge.state is defined %}
          {% set level = states.sensor.server_rack_ups_battery_charge.state | int %}
          {% if level | float == 100 %}
            mdi:battery
          {% elif level | float < 10 %}
            mdi:battery-outline
          {% else %}
            {% set icon_level = (level / 10) | int * 10 %}
            mdi:battery-{{ icon_level }}
          {% endif %}
        {% else %}
          mdi:battery-alert
        {% endif %}
    dashboard_battery_server_rack_ups:
      friendly_name: 'Server Rack UPS'
      entity_id: sensor.battery_server_rack_ups
      value_template: >-
        {% if states.sensor.battery_server_rack_ups.state | int <= 50 %}
          on
        {% else %}
          off
        {% endif %}


# Networked Devices
- platform: template
  sensors:
    network_overwatch:
      friendly_name: Overwatch
      entity_id: device_tracker.overwatch
      value_template: >
        {{ ('online' if is_state('device_tracker.overwatch', 'home') else 'offline') | title }}
      icon_template: 'mdi:server'
    network_pfsense:
      friendly_name: pfSense
      entity_id: device_tracker.pfsense
      value_template: >
        {{ ('online' if is_state('device_tracker.pfsense', 'home') else 'offline') | title }}
      icon_template: 'mdi:server'
    network_unifi_ap_downstairs:
      friendly_name: UniFi AP Downstairs
      entity_id: device_tracker.unifi_ap_downstairs
      value_template: >
        {{ ('online' if is_state('device_tracker.unifi_ap_downstairs', 'home') else 'offline') | title }}
      icon_template: 'mdi:access-point-network'
    network_unifi_ap_upstairs:
      friendly_name: UniFi AP Upstairs
      entity_id: device_tracker.unifi_ap_upstairs
      value_template: >
        {{ ('online' if is_state('device_tracker.unifi_ap_upstairs', 'home') else 'offline') | title }}
      icon_template: 'mdi:access-point-network'
    network_unifi_cloudkey:
      friendly_name: UniFi Cloud Key Plus
      entity_id: device_tracker.unifi_cloudkey
      value_template: >
        {{ ('online' if is_state('device_tracker.unifi_cloudkey', 'home') else 'offline') | title }}
      icon_template: 'mdi:mixcloud'
    network_unifi_switch_16:
      friendly_name: UniFi Switch 16
      entity_id: device_tracker.unifi_switch_16
      value_template: >
        {{ ('online' if is_state('device_tracker.unifi_switch_16', 'home') else 'offline') | title }}
      icon_template: 'mdi:switch'
    network_unifi_switch_8_downstairs:
      friendly_name: UniFi Switch 8 - Downstairs
      entity_id: device_tracker.unifi_switch_8_downstairs
      value_template: >
        {{ ('online' if is_state('device_tracker.unifi_switch_8_downstairs', 'home') else 'offline') | title }}
      icon_template: 'mdi:switch'
    network_unifi_switch_8_upstairs:
      friendly_name: UniFi Switch 8 - Upstairs
      entity_id: device_tracker.unifi_switch_8_upstairs
      value_template: >
        {{ ('online' if is_state('device_tracker.unifi_switch_8_upstairs', 'home') else 'offline') | title }}
      icon_template: 'mdi:switch'
    network_woodhouse:
      friendly_name: Woodhouse
      entity_id: group.device_tracker_woodhouse
      value_template: >
        {{ ('online' if is_state('group.device_tracker_woodhouse', 'home') else 'offline') | title }}
      icon_template: 'mdi:server'
    network_uvc_front_door:
      friendly_name: UVC Front Door
      entity_id: device_tracker.uvc_front_door
      value_template: >
        {{ ('online' if is_state('device_tracker.uvc_front_door', 'home') else 'offline') | title }}
      icon_template: 'mdi:cctv'
    network_uvc_garage:
      friendly_name: UVC Garage
      entity_id: device_tracker.uvc_garage
      value_template: >
        {{ ('online' if is_state('device_tracker.uvc_garage', 'home') else 'offline') | title }}
      icon_template: 'mdi:cctv'
    network_uvc_main_floor:
      friendly_name: UVC Main Floor
      entity_id: device_tracker.uvc_main_floor
      value_template: >
        {{ ('online' if is_state('device_tracker.uvc_main_floor', 'home') else 'offline') | title }}
      icon_template: 'mdi:cctv'
    network_uvc_main_patio:
      friendly_name: UVC Main Patio
      entity_id: device_tracker.uvc_main_patio
      value_template: >
        {{ ('online' if is_state('device_tracker.uvc_main_patio', 'home') else 'offline') | title }}
      icon_template: 'mdi:cctv'



# Custom sensors for dashboard views
- platform: template
  sensors:
    dashboard_inside_average_temperature:
      friendly_name: 'Average Temperature'
      entity_id: sensor.average_temperature
      value_template: '{{ states.sensor.average_temperature.state | round() }}'
      unit_of_measurement: 'ºF'
    dashboard_inside_average_humidity:
      friendly_name: 'Average Humidity'
      entity_id: sensor.average_humidity
      value_template: '{{ states.sensor.average_humidity.state | round() }}'
      unit_of_measurement: '%'
    dashboard_outside_temperature:
      friendly_name: 'Temperature'
      entity_id: sensor.dark_sky_temperature
      value_template: '{{ states.sensor.dark_sky_temperature.state | round() }}'
      unit_of_measurement: 'ºF'
    dashboard_outside_high_temperature:
      friendly_name: 'High'
      entity_id: sensor.dark_sky_daytime_high_temperature_0d
      value_template: '{{ states.sensor.dark_sky_daytime_high_temperature_0d.state | round() }}'
      unit_of_measurement: 'ºF'
    dashboard_outside_low_temperature:
      friendly_name: 'Low'
      entity_id: sensor.dark_sky_overnight_low_temperature_0d
      value_template: '{{ states.sensor.dark_sky_overnight_low_temperature_0d.state | round() }}'
      unit_of_measurement: 'ºF'
    dashboard_outside_humidity:
      friendly_name: 'Humidity'
      entity_id: sensor.dark_sky_humidity_0d
      value_template: '{{ states.sensor.dark_sky_humidity_0d.state | round() }}'
      unit_of_measurement: '%'
    dashboard_current_home_mode:
      friendly_name: 'Current Home Mode'
      entity_id:
        - input_boolean.mode_morning
        - input_boolean.mode_day
        - input_boolean.mode_sunset
        - input_boolean.mode_night
      value_template: >-
        {% if is_state('input_boolean.mode_morning', 'on') %}
          Morning
        {% elif is_state('input_boolean.mode_day', 'on') %}
          Day
        {% elif is_state('input_boolean.mode_sunset', 'on') %}
          Sunset
        {% elif is_state('input_boolean.mode_night', 'on') %}
          Night
        {% else %}
          Unknown
        {% endif %}
      icon_template: >-
        {% if is_state('input_boolean.mode_morning', 'on') %}
          mdi:weather-hazy
        {% elif is_state('input_boolean.mode_day', 'on') %}
          mdi:weather-sunny
        {% elif is_state('input_boolean.mode_sunset', 'on') %}
          mdi:weather-sunset
        {% elif is_state('input_boolean.mode_night', 'on') %}
          mdi:weather-night
        {% else %}
          mdi:weather-cloudy-alert
        {% endif %}
    dashboard_current_mode:
      friendly_name: 'Current Mode'
      entity_id:
        - input_boolean.mode_guest
        - input_boolean.mode_home_theater
        - input_boolean.mode_sleep
        - input_boolean.mode_morning
        - input_boolean.mode_day
        - input_boolean.mode_sunset
        - input_boolean.mode_night
      value_template: >-
        {% if is_state('input_boolean.mode_sleep', 'on') %}
          Sleep
        {% elif is_state('input_boolean.mode_home_theater', 'on') %}
          Theater
        {% elif is_state('input_boolean.mode_guest', 'on') %}
          Guest
        {% elif is_state('input_boolean.mode_morning', 'on') %}
          Morning
        {% elif is_state('input_boolean.mode_day', 'on') %}
          Day
        {% elif is_state('input_boolean.mode_sunset', 'on') %}
          Sunset
        {% elif is_state('input_boolean.mode_night', 'on') %}
          Night
        {% else %}
          Unknown
        {% endif %}
      icon_template: >-
        {% if is_state('input_boolean.mode_sleep', 'on') %}
          mdi:sleep
        {% elif is_state('input_boolean.mode_home_theater', 'on') %}
          mdi:theater
        {% elif is_state('input_boolean.mode_guest', 'on') %}
          mdi:human-greeting
        {% elif is_state('input_boolean.mode_morning', 'on') %}
          mdi:weather-hazy
        {% elif is_state('input_boolean.mode_day', 'on') %}
          mdi:weather-sunny
        {% elif is_state('input_boolean.mode_sunset', 'on') %}
          mdi:weather-sunset
        {% elif is_state('input_boolean.mode_night', 'on') %}
          mdi:weather-night
        {% else %}
          mdi:weather-cloudy-alert
        {% endif %}
    dashboard_home_state:
      friendly_name: Home State
      entity_id:
        - binary_sensor.garage_actual
        - lock.august_smart_lock_pro_front_door
        - lock.august_smart_lock_pro_garage_door
        - group.all_doors
      value_template: >-
        {% if states.binary_sensor.garage_actual.state == 'off' and states.lock.august_smart_lock_pro_front_door.state == 'locked' and states.lock.august_smart_lock_pro_garage_door.state == 'locked' and states.group.all_doors.state == 'off' %}
          Secure
        {% else %}
          Insecure
        {% endif %}
      icon_template: >-
        {% if states.binary_sensor.garage_actual.state == 'off' and states.lock.august_smart_lock_pro_front_door.state == 'locked' and states.lock.august_smart_lock_pro_garage_door.state == 'locked' and states.group.all_doors.state == 'off' %}
          mdi:shield-home
        {% else %}
          mdi:shield-off
        {% endif %}
    dashboard_occupancy_state:
      friendly_name: Occupancy State
      entity_id:
        - group.residents
        - sensor.mode_guest
      value_template: >-
        {% if is_state("group.residents", "home") %}
          Resident
        {% elif is_state("sensor.mode_guest", "on") %}
          Guest
        {% else %}
          Cats
        {% endif %}
      icon_template: >-
        {% if is_state("group.residents", "home") %}
          mdi:account-multiple
        {% elif is_state("sensor.mode_guest", "on") %}
          mdi:human-greeting
        {% else %}
          mdi:cat
        {% endif %}
    dashboard_simulate_presence_status:
      friendly_name: Simulate Presence Status
      entity_id: input_boolean.mode_simulate_presence
      value_template: >
        {% if is_state('input_boolean.mode_simulate_presence', 'on') %}
          Simulating presence.
        {% else %}
          off
        {% endif %}
    dashboard_garage_actual_status:
      friendly_name: Garage Actual Status
      entity_id: cover.garage_actual
      value_template: >-
        {{ off if is_state("cover.garage_actual", "closed") else "Garage Actual is open." }}
    dashboard_open_window_status:
      friendly_name: Open Window Status
      entity_id:
        - binary_sensor.kitchen_windows
        - binary_sensor.kitchen_windows
        - binary_sensor.living_room_windows
        - binary_sensor.living_room_windows
        - binary_sensor.rec_room_windows
        - binary_sensor.rec_room_windows
        - binary_sensor.bedroom_windows
        - binary_sensor.bedroom_windows
        - binary_sensor.den_windows
        - binary_sensor.den_windows
        - binary_sensor.guest_bedroom_windows
        - binary_sensor.guest_bedroom_windows
      value_template: >-
        {% set num_windows = states.binary_sensor
          | selectattr('entity_id', 'in', states.group.all_windows.attributes.entity_id)
          | selectattr('state', 'eq', 'on')
          | list
          | length
        %}
        {% set num_downstairs = states.binary_sensor
          | selectattr('entity_id', 'in', states.group.downstairs_windows.attributes.entity_id)
          | selectattr('state', 'eq', 'on')
          | list
          | length
        %}
        {% set num_upstairs = states.binary_sensor
          | selectattr('entity_id', 'in', states.group.upstairs_windows.attributes.entity_id)
          | selectattr('state', 'eq', 'on')
          | list
          | length
        %}

        {% if num_windows > 1 %}
          {% if num_downstairs == 0 %}
            {{ num_windows}} upstairs windows are open.
          {% elif num_upstairs == 0 %}
            {{ num_windows}} downstairs windows are open.
          {% else %}
            {{ num_windows}} windows are open.
          {% endif %}
        {% elif num_windows == 1 %}
          {% set open_window = states.binary_sensor
            | selectattr('entity_id', 'in', states.group.all_windows.attributes.entity_id)
            | selectattr('state', 'eq', 'on')
            | first
          %}
          {{ open_window.attributes.friendly_name }} are open.
        {% else %}
          off
        {% endif %}
    dashboard_open_door_status:
      friendly_name: Open Door Status
      entity_id:
        - binary_sensor.garage_door
        - binary_sensor.front_door
        - binary_sensor.patio_door
        - binary_sensor.den_door
      value_template: >-
        {% set num_doors = states.binary_sensor
          | selectattr('entity_id', 'in', states.group.all_doors.attributes.entity_id)
          | selectattr('state', 'eq', 'on')
          | list
          | length
        %}

        {% if num_doors > 1 %}
          {{ num_doors}} doors are open.
        {% elif num_doors == 1 %}
          {% set open_door = states.binary_sensor
            | selectattr('entity_id', 'in', states.group.all_doors.attributes.entity_id)
            | selectattr('state', 'eq', 'on')
            | first
          %}
          {{ open_door.attributes.friendly_name }} is open.
        {% else %}
          off
        {% endif %}
    dashboard_unlocked_door_status:
      friendly_name: Unlocked Door Status
      entity_id:
        - lock.august_smart_lock_pro_front_door
        - lock.august_smart_lock_pro_garage_door
      value_template: >-
        {% set num = states.lock
          | selectattr('entity_id', 'in', states.group.all_locks.attributes.entity_id)
          | selectattr('state', 'eq', 'unlocked')
          | list
          | length
        %}

        {% if num == 2 %}
          Front Door and Garage Door are unlocked.
        {% elif num ==1 and is_state("lock.august_smart_lock_pro_front_door", "unlocked") %}
          Front Door is unlocked.
        {% elif num ==1 and is_state("lock.august_smart_lock_pro_garage_door", "unlocked") %}
          Garage Door is unlocked.
        {% else %}
          off
        {% endif %}
    dashboard_lights_on_status:
      friendly_name: Lights On Status
      entity_id:
        - light.garage_lights
        - light.garage_stairs
        - light.downstairs_hallway
        - light.kitchen
        - light.patio_lights
        - light.patio_string_lights
        - light.living_room
        - light.living_room_tv
        - light.rec_room_lights
        - light.rec_room_tiles
        - light.main_stairs
        - light.upstairs_hallway
        - light.bedroom_hallway
        - light.bedroom_lights
        - light.bedroom_tiles
        - light.bedroom_closet_lights
        - light.laundry_lights
        - light.den_hallway
        - light.den_lights
        - light.den_cabinets
        - light.guest_bedroom_closet_lights
      value_template: >-
        {% set num_lights = states.light
          | selectattr('entity_id', 'in', states.group.all_lights.attributes.entity_id)
          | selectattr('state', 'eq', 'on')
          | list
          | length
        %}

        {% if num_lights > 1 %}
          {{ num_lights}} lights are on.
        {% elif num_lights == 1 %}
          {% set lights_on = states.light
            | selectattr('entity_id', 'in', states.group.all_lights.attributes.entity_id)
            | selectattr('state', 'eq', 'on')
            | first
          %}
          {{ lights_on.attributes.friendly_name }} are on.
        {% else %}
          off
        {% endif %}
    dashboard_sonos_song_status:
      friendly_name: Sonos Song Status
      entity_id:
        - media_player.sonos_kitchen
        - media_player.sonos_living_room
        - media_player.sonos_rec_room
        - media_player.sonos_bedroom
        - media_player.sonos_bathroom
        - media_player.sonos_den
        - media_player.sonos_move
        - sensor.sonos_speakers_join
      value_template: >-
        {% set group_master = states("sensor.sonos_group_master") %}

        {% if group_master != none %}
          {% if is_state("sensor.sonos_group_master_state", "playing") %}
            {{ state_attr(group_master, "media_artist") }} – {{ state_attr(group_master, "media_title") }}
          {% else %}
            Nothing is playing.
          {% endif %}
        {% else %}
          off
        {% endif %}
    dashboard_sonos_speaker_status:
      friendly_name: Sonos Speaker Status
      entity_id:
        - media_player.sonos_kitchen
        - media_player.sonos_living_room
        - media_player.sonos_rec_room
        - media_player.sonos_bedroom
        - media_player.sonos_bathroom
        - media_player.sonos_den
        - media_player.sonos_move
        - sensor.sonos_speakers_join
      value_template: >-
        {% if group_master != none %}
          {{ state_attr(states("sensor.sonos_group_master"), "friendly_name") }} + {{ states("sensor.sonos_speakers_join").split(',') | length }}
        {% else %}
          off
        {% endif %}

    dashboard_water_delivery:
      friendly_name: Water Delivery
      entity_id: sensor.time
      value_template: >-
        {% set nextdelivery = as_timestamp(states.calendar.readyrefresh.attributes.start_time)|timestamp_custom('%Y-%m-%d') %}
        {% set daybefore = as_timestamp(now())|timestamp_custom('%Y-%m-%d') == (as_timestamp(states.calendar.readyrefresh.attributes.start_time) - (24*60*60))|timestamp_custom('%Y-%m-%d') and now().strftime("%H")|int >= 17 %}
        {% set dayof = states.sensor.date.state == nextdelivery %}
        {% if daybefore or dayof %}
          on
        {% else %}
          off
        {% endif %}
      icon_template: 'mdi:cup-water'
    dashboard_water_delivery_title:
      friendly_name: Water Delivery Title
      entity_id:
        - sensor.date
        - calendar.readyrefresh
      value_template: >-
        {% set nextdelivery = as_timestamp(states.calendar.readyrefresh.attributes.start_time)|timestamp_custom('%Y-%m-%d') %}
        {% set fivedaysbefore = as_timestamp(now()) > (as_timestamp(states.calendar.readyrefresh.attributes.start_time) - (24*60*60*5)) and as_timestamp(now()) < as_timestamp(states.calendar.readyrefresh.attributes.start_time) %}
        {% set daybefore = as_timestamp(now())|timestamp_custom('%Y-%m-%d') == (as_timestamp(states.calendar.readyrefresh.attributes.start_time) - (24*60*60))|timestamp_custom('%Y-%m-%d') %}
        {% set dayof = states.sensor.date.state == nextdelivery %}
        {% if daybefore %}
          Tomorrow
        {% elif dayof %}
          Today
        {% elif fivedaysbefore %}
          {{ as_timestamp(states.calendar.readyrefresh.attributes.start_time)|timestamp_custom('%A') }}
        {% else %}
          {{ as_timestamp(states.calendar.readyrefresh.attributes.start_time)|timestamp_custom('%B %-d') }}
        {% endif %}
      icon_template: 'mdi:cup-water'
    dashboard_trash_pickup:
      friendly_name: Trash Pickup
      entity_id: sensor.time
      value_template: >-
        {% set nextpickup = states.input_text.next_pickup_trash.state %}
        {% set daybefore = as_timestamp(now())|timestamp_custom('%Y-%m-%d') == (as_timestamp(states.input_text.next_pickup_trash.state + ' 00:00:00') - (24*60*60))|timestamp_custom('%Y-%m-%d') and now().strftime("%H")|int >= 17 %}
        {% set dayof = states.sensor.date.state == nextpickup %}
        {% if daybefore or dayof %}
          on
        {% else %}
          off
        {% endif %}
      icon_template: >-
        {% set nextpickup = states.input_text.next_pickup_trash.state %}
        {% set daybefore = as_timestamp(now())|timestamp_custom('%Y-%m-%d') == (as_timestamp(states.input_text.next_pickup_trash.state + ' 00:00:00') - (24*60*60))|timestamp_custom('%Y-%m-%d') and now().strftime("%H")|int >= 17 %}
        {% set dayof = states.sensor.date.state == nextpickup %}
        {% if daybefore or dayof %}
          mdi:delete-empty
        {% else %}
          mdi:delete
        {% endif %}
    dashboard_trash_pickup_title:
      friendly_name: Trash Pickup Title
      entity_id: sensor.time
      value_template: >-
        {% set nextpickup = states.input_text.next_pickup_trash.state %}
        {% set daybefore = as_timestamp(now())|timestamp_custom('%Y-%m-%d') == (as_timestamp(states.input_text.next_pickup_trash.state + ' 00:00:00') - (24*60*60))|timestamp_custom('%Y-%m-%d') %}
        {% set dayof = states.sensor.date.state == nextpickup %}
        {% if daybefore %}
          Tomorrow
        {% elif dayof %}
          Today
        {% else %}
          {{ as_timestamp(states.input_text.next_pickup_trash.state + ' 00:00:00')|timestamp_custom('%A') }}
        {% endif %}
      icon_template: >-
        {% set nextpickup = states.input_text.next_pickup_trash.state %}
        {% set daybefore = as_timestamp(now())|timestamp_custom('%Y-%m-%d') == (as_timestamp(states.input_text.next_pickup_trash.state + ' 00:00:00') - (24*60*60))|timestamp_custom('%Y-%m-%d') and now().strftime("%H")|int >= 17 %}
        {% set dayof = states.sensor.date.state == nextpickup %}
        {% if daybefore or dayof %}
          mdi:delete-empty
        {% else %}
          mdi:delete
        {% endif %}
    dashboard_recycling_pickup:
      friendly_name: Recycling Pickup
      entity_id: sensor.time
      value_template: >-
        {% set nextpickup = states.input_text.next_pickup_recycling.state %}
        {% set daybefore = as_timestamp(now())|timestamp_custom('%Y-%m-%d') == (as_timestamp(states.input_text.next_pickup_recycling.state + ' 00:00:00') - (24*60*60))|timestamp_custom('%Y-%m-%d') and now().strftime("%H")|int >= 17 %}
        {% set dayof = states.sensor.date.state == nextpickup %}
        {% if daybefore or dayof %}
          on
        {% else %}
          off
        {% endif %}
      icon_template: 'mdi:recycle'
    dashboard_recycling_pickup_title:
      friendly_name: Recycling Pickup Title
      entity_id: sensor.time
      value_template: >-
        {% set nextpickup = states.input_text.next_pickup_recycling.state %}
        {% set daybefore = as_timestamp(now())|timestamp_custom('%Y-%m-%d') == (as_timestamp(states.input_text.next_pickup_recycling.state + ' 00:00:00') - (24*60*60))|timestamp_custom('%Y-%m-%d') %}
        {% set dayof = states.sensor.date.state == nextpickup %}
        {% if daybefore %}
          Tomorrow
        {% elif dayof %}
          Today
        {% else %}
          {{ as_timestamp(states.input_text.next_pickup_recycling.state + ' 00:00:00')|timestamp_custom('%A') }}
        {% endif %}
      icon_template: 'mdi:recycle'
    dashboard_bedroom_fan_filter:
      friendly_name: Bedroom Fan Filter
      entity_id: fan.bedroom
      value_template: >-
        {% if states.fan.bedroom.attributes["hepa_filter"] <= 33 %}
          on
        {% else %}
          off
        {% endif %}
      icon_template: 'mdi:air-filter'
    dashboard_kitchen_fan_hepa_filter:
      friendly_name: Kitchen Fan HEPA Filter
      entity_id: fan.kitchen
      value_template: >-
        {% if states.fan.kitchen.attributes["hepa_filter"] <= 33 %}
          on
        {% else %}
          off
        {% endif %}
      icon_template: 'mdi:air-filter'
    dashboard_kitchen_fan_carbon_filter:
      friendly_name: Kitchen Fan Carbon Filter
      entity_id: fan.kitchen
      value_template: >-
        {% if states.fan.kitchen.attributes["carbon_filter"] <= 33 %}
          on
        {% else %}
          off
        {% endif %}
      icon_template: 'mdi:air-filter'
#    dashboard_octavia_fuel_remaining:
#      friendly_name: Octavia Fuel Remaining
#      entity_id: device_tracker.octavia
#      value_template: >-
#        {% if states.device_tracker.octavia.attributes["fuel_level"] <= 33 %}
#          on
#        {% else %}
#          off
#        {% endif %}
#      icon_template: 'mdi:gas-station'
    dashboard_neato_rory_status:
      friendly_name: Rory
      entity_id: vacuum.rory
      value_template: >-
        {% if states.vacuum.rory.state != 'docked' %}
          on
        {% else %}
          off
        {% endif %}
      icon_template: 'mdi:robot-vacuum-variant'
    dashboard_neato_rory_last_cleaned:
      friendly_name: Rory - Last Cleaned
      entity_id: vacuum.rory
      value_template: >-
        {% set lastcleaned = as_timestamp(states.vacuum.rory.attributes.clean_stop) %}
        {% set fivedaysbefore = (as_timestamp(now()) - (24*60*60*5)) < lastcleaned and as_timestamp(now()) > lastcleaned %}
        {% set daybefore = (as_timestamp(now()) - (24*60*60))|timestamp_custom('%Y-%m-%d') == lastcleaned|timestamp_custom('%Y-%m-%d') %}
        {% set dayof = states.sensor.date.state == lastcleaned|timestamp_custom('%Y-%m-%d') %}
        {% if daybefore %}
          Yesterday
        {% elif dayof %}
          Today
        {% elif fivedaysbefore %}
          {{ lastcleaned|timestamp_custom('%A') }}
        {% else %}
          {{ lastcleaned|timestamp_custom('%B %-d') }}
        {% endif %}
    dashboard_neato_amelia_status:
      friendly_name: Amelia
      entity_id: vacuum.amelia
      value_template: >-
        {% if states.vacuum.amelia.state != 'docked' %}
          on
        {% else %}
          off
        {% endif %}
      icon_template: 'mdi:robot-vacuum-variant'
    dashboard_neato_amelia_last_cleaned:
      friendly_name: Amelia - Last Cleaned
      entity_id: vacuum.amelia
      value_template: >-
        {% set lastcleaned = as_timestamp(states.vacuum.amelia.attributes.clean_stop) %}
        {% set fivedaysbefore = (as_timestamp(now()) - (24*60*60*5)) < lastcleaned and as_timestamp(now()) > lastcleaned %}
        {% set daybefore = (as_timestamp(now()) - (24*60*60))|timestamp_custom('%Y-%m-%d') == lastcleaned|timestamp_custom('%Y-%m-%d') %}
        {% set dayof = states.sensor.date.state == lastcleaned|timestamp_custom('%Y-%m-%d') %}
        {% if daybefore %}
          Yesterday
        {% elif dayof %}
          Today
        {% elif fivedaysbefore %}
          {{ lastcleaned|timestamp_custom('%A') }}
        {% else %}
          {{ lastcleaned|timestamp_custom('%B %-d') }}
        {% endif %}


# Alexa Wakeup Light
- platform: template
  sensors:
    alexa_wakeup_light:
      friendly_name: Alexa Wakeup Light
      entity_id: sensor.time
      value_template: >-
        {% set alarmset = not is_state("sensor.bedroom_sonos_one_next_alarm", "") and not is_state("sensor.bedroom_sonos_one_next_alarm", none) and not is_state("sensor.bedroom_sonos_one_next_alarm", "unavailable") %}
        {% if alarmset %}
          {% set fifteenbefore = (as_timestamp(states("sensor.bedroom_sonos_one_next_alarm")) - (20*60)) %}
          {% set nextalarm = fifteenbefore | timestamp_custom('%Y-%m-%d') %}
          {% set starttime = fifteenbefore | timestamp_custom('%H:%M') %}
          {% set dayof = states('sensor.date') == nextalarm %}
        {% endif %}

        {% if alarmset %}
          {% if dayof and starttime == as_timestamp(now()) | timestamp_custom('%H:%M') %}
            on
          {% else %}
            off
          {% endif %}
        {% else %}
          off
        {% endif %}
    alexa_next_alarm:
      friendly_name: Alexa Next Alarm
      entity_id:
        - sensor.time
        - sensor.bedroom_sonos_one_next_alarm
      value_template: >-
        {% set alarmset = not is_state("sensor.bedroom_sonos_one_next_alarm", "") and not is_state("sensor.bedroom_sonos_one_next_alarm", none) and not is_state("sensor.bedroom_sonos_one_next_alarm", "unavailable") %}
        {% if alarmset %}
          {% set nextalarm = as_timestamp(states("sensor.bedroom_sonos_one_next_alarm")) %}
          {% set dayof = states("sensor.date") == nextalarm | timestamp_custom('%Y-%m-%d') %}
          {% set ispast = nextalarm < as_timestamp(now()) %}
        {% endif %}

        {% if alarmset %}
          {% if ispast %}
            Expired
          {% else %}
            {{ as_timestamp(states("sensor.bedroom_sonos_one_next_alarm")) | timestamp_custom('%a %-I:%M %p') }}
          {% endif %}
        {% else %}
          None
        {% endif %}
      icon_template: >-
        {% set alarmset = not is_state("sensor.bedroom_sonos_one_next_alarm", "") and not is_state("sensor.bedroom_sonos_one_next_alarm", none) and not is_state("sensor.bedroom_sonos_one_next_alarm", "unavailable") %}
        {% if alarmset %}
          {% set nextalarm = as_timestamp(states("sensor.bedroom_sonos_one_next_alarm")) %}
          {% set ispast = nextalarm < as_timestamp(now()) %}
        {% endif %}

        {% if alarmset %}
          {% if ispast %}
            mdi:alarm-off
          {% else %}
            mdi:alarm
          {% endif %}
        {% else %}
          mdi:alarm-off
        {% endif %}

# Sonos Grouping Sensors
- platform: template
  sensors:
    sonos_group_master:
      friendly_name: Sonos Group Master
      entity_id:
        - media_player.sonos_kitchen
        - media_player.sonos_living_room
        - media_player.sonos_rec_room
        - media_player.sonos_bedroom
        - media_player.sonos_bathroom
        - media_player.sonos_den
        - media_player.sonos_move
      value_template: >-
        {%- for player in states.media_player if player.attributes.sonos_group and player.state == 'playing' and player.attributes.sonos_group[0] == player.entity_id and player.attributes.source is not defined %}
          {% if loop.last %}
            {{ player.entity_id }}
          {% endif %}
        {% else %}
          {{ 'media_player.sonos_'+ states.input_select.master_sonos.state|lower|replace(" ", "_") }}
        {% endfor -%}

    sonos_group_master_state:
      friendly_name: Sonos Group Master
      entity_id:
        - media_player.sonos_kitchen
        - media_player.sonos_living_room
        - media_player.sonos_rec_room
        - media_player.sonos_bedroom
        - media_player.sonos_bathroom
        - media_player.sonos_den
        - media_player.sonos_move
      value_template: >-
        {% set master = states.sensor.sonos_group_master.state %}
        {%- if is_state(master, "playing") %}
          playing
        {% else %}
          paused
        {% endif -%}

    sonos_speakers_join:
      friendly_name: Sonos Join Speakers
      entity_id:
        - input_boolean.sonos_kitchen
        - input_boolean.sonos_living_room
        - input_boolean.sonos_rec_room
        - input_boolean.sonos_bedroom
        - input_boolean.sonos_bathroom
        - media_player.sonos_den
        - media_player.sonos_move
      value_template: >-
        {% set master = states.sensor.sonos_group_master.state %}
        {% for switch in states.input_boolean if "sonos" in switch.entity_id and switch.state == "on" and switch.entity_id|replace("input_boolean", "media_player") != master -%}
          {{ switch.entity_id|replace("input_boolean", "media_player") }}
          {%- if not loop.last -%}
            ,
          {%- endif %}
        {%- endfor %}

    sonos_speakers_unjoin:
      friendly_name: Sonos Unjoin Speakers
      entity_id: sensor.sonos_speakers_join
      value_template: >-
        {% set master = states.sensor.sonos_group_master.state %}
        {% for switch in states.input_boolean if "sonos" in switch.entity_id and switch.state == "off" and switch.entity_id|replace("input_boolean", "media_player") != master -%}
          {{ switch.entity_id|replace("input_boolean", "media_player") }}
          {%- if not loop.last -%}
            ,
          {%- endif %}
        {%- endfor %}

    sonos_switches_on:
      friendly_name: Sonos Switches On
      entity_id:
        - media_player.sonos_kitchen
        - media_player.sonos_living_room
        - media_player.sonos_rec_room
        - media_player.sonos_bedroom
        - media_player.sonos_bathroom
        - media_player.sonos_den
        - media_player.sonos_move
      value_template: >-
        {% set master = 'media_player.sonos_'+ states.input_select.master_sonos.state|lower|replace(" ", "_") %}
        {%- for player in states.media_player if player.attributes.sonos_group and player.entity_id == master %}
          {%- set slaves = player.attributes.sonos_group %}
          {{ slaves|join(",")|replace("media_player", "input_boolean") }}
        {%- endfor %}

    sonos_switches_off:
      friendly_name: Sonos Switches Off
      entity_id: sensor.sonos_switches_on
      value_template: >-
        {% set master = 'media_player.sonos_'+ states.input_select.master_sonos.state|lower|replace(" ", "_") %}
        {% for player in states.media_player if player.attributes.sonos_group and player.attributes.sonos_group|length == 1 and player.entity_id != master -%}
          {{ player.entity_id|replace("media_player", "input_boolean") }}
          {%- if not loop.last -%}
            ,
          {%- endif -%}
        {%- endfor %}


# Sonos Volume Sensors
- platform: template
  sensors:
    sonos_kitchen_volume:
      friendly_name: Sonos Kitchen Volume
      entity_id: media_player.sonos_kitchen
      value_template: >-
        {%- if state_attr('media_player.sonos_kitchen', 'volume_level') is defined -%}
          {{ (state_attr('media_player.sonos_kitchen', 'volume_level') * 100) | int ~ '%' }}
        {%- else -%}
          Unavailable
        {%- endif %}
    sonos_living_room_volume:
      friendly_name: Sonos Living Room Volume
      entity_id: media_player.sonos_living_room
      value_template: >-
        {%- if state_attr('media_player.sonos_living_room', 'volume_level') is defined -%}
          {{ (state_attr('media_player.sonos_living_room', 'volume_level') * 100) | int ~ '%' }}
        {%- else -%}
          Unavailable
        {%- endif %}
    sonos_rec_room_volume:
      friendly_name: Sonos Rec Room Volume
      entity_id: media_player.sonos_rec_room
      value_template: >-
        {%- if state_attr('media_player.sonos_rec_room', 'volume_level') is defined -%}
          {{ (state_attr('media_player.sonos_rec_room', 'volume_level') * 100) | int ~ '%' }}
        {%- else -%}
          Unavailable
        {%- endif %}
    sonos_bedroom_volume:
      friendly_name: Sonos Bedroom Volume
      entity_id: media_player.sonos_bedroom
      value_template: >-
        {%- if state_attr('media_player.sonos_bedroom', 'volume_level') is defined -%}
          {{ (state_attr('media_player.sonos_bedroom', 'volume_level') * 100) | int ~ '%' }}
        {%- else -%}
          Unavailable
        {%- endif %}
    sonos_bathroom_volume:
      friendly_name: Sonos Bathroom Volume
      entity_id: media_player.sonos_bathroom
      value_template: >-
        {%- if state_attr('media_player.sonos_bathroom', 'volume_level') is defined -%}
          {{ (state_attr('media_player.sonos_bathroom', 'volume_level') * 100) | int ~ '%' }}
        {%- else -%}
          Unavailable
        {%- endif %}
    sonos_den_volume:
      friendly_name: Sonos Den Volume
      entity_id: media_player.sonos_den
      value_template: >-
        {%- if state_attr('media_player.sonos_den', 'volume_level') is defined -%}
          {{ (state_attr('media_player.sonos_den', 'volume_level') * 100) | int ~ '%' }}
        {%- else -%}
          Unavailable
        {%- endif %}
    sonos_move_volume:
      friendly_name: Sonos Move Volume
      entity_id: media_player.sonos_move
      value_template: >-
        {%- if state_attr('media_player.sonos_move', 'volume_level') is defined -%}
          {{ (state_attr('media_player.sonos_move', 'volume_level') * 100) | int ~ '%' }}
        {%- else -%}
          Unavailable
        {%- endif %}


# Preferred Lighting Time Sensors
- platform: template
  sensors:
    prefer_weekday_lighting_low:
      friendly_name: Prefer Weekday Lighting Low Time
      value_template: '21:00'
    prefer_weekday_lighting_mid:
      friendly_name: Prefer Weekday Lighting Mid Time
      entity_id:
       - sensor.date
       - sensor.prefer_weekday_lighting_low
       - sensor.suncalc_sunsetstart
      value_template: >-
        {% set time   = as_timestamp(now()) | timestamp_custom("%H:%M") %}
        {% set today  = as_timestamp(now()) | timestamp_custom('%Y-%m-%d') %}
        {% set sunset = as_timestamp(today ~ " " ~ states.sensor.suncalc_sunsetstart.state) %}
        {% set prefer_weekday_low = states.sensor.prefer_weekday_lighting_low.state %}
        {{ (((as_timestamp(today ~ " " ~ prefer_weekday_low) - sunset) / 2) + sunset) | timestamp_custom("%H:%M") }}
    prefer_weekday_lighting_high:
      friendly_name: Prefer Weekday Lighting High Time
      entity_id: sensor.suncalc_goldenhourend
      value_template: '{{ states("sensor.suncalc_goldenhourend") }}'
    prefer_weekend_lighting_low:
      friendly_name: Prefer Weekend Lighting Low Time
      value_template: '22:00'
    prefer_weekend_lighting_mid:
      friendly_name: Prefer Weekend Lighting Mid Time
      entity_id:
       - sensor.date
       - sensor.prefer_weekend_lighting_low
       - sensor.suncalc_sunsetstart
      value_template: >-
        {% set time   = as_timestamp(now()) | timestamp_custom("%H:%M") %}
        {% set today  = as_timestamp(now()) | timestamp_custom('%Y-%m-%d') %}
        {% set sunset = as_timestamp(today ~ " " ~ states.sensor.suncalc_sunsetstart.state) %}
        {% set prefer_weekend_low = states.sensor.prefer_weekend_lighting_low.state %}
        {{ (((as_timestamp(today ~ " " ~ prefer_weekend_low) - sunset) / 2) + sunset) | timestamp_custom("%H:%M") }}
    prefer_weekend_lighting_high:
      friendly_name: Prefer Weekend Lighting High Time
      entity_id: sensor.suncalc_goldenhourend
      value_template: '{{ states("sensor.suncalc_goldenhourend") }}'


# Preferred Lighting Time Sensors - Display
- platform: template
  sensors:
    dashboard_prefer_lighting_low:
      friendly_name: Prefer Lighting Low Time
      entity_id:
        - sensor.prefer_weekday_lighting_low
        - sensor.prefer_weekend_lighting_low
      value_template: >-
        {% set day = "weekday" if now().strftime("%A")|lower in ["sunday", "monday", "tuesday", "wednesday", "thursday"] else "weekend" %}
        {{ as_timestamp(states("sensor.date") + " " + states("sensor.prefer_" ~ day ~ "_lighting_low")) | timestamp_custom("%-I:%M %p") }}
    dashboard_prefer_lighting_mid:
      friendly_name: Prefer Lighting Mid Time
      entity_id:
        - sensor.prefer_weekday_lighting_mid
        - sensor.prefer_weekend_lighting_mid
      value_template: >-
        {% set day = "weekday" if now().strftime("%A")|lower in ["sunday", "monday", "tuesday", "wednesday", "thursday"] else "weekend" %}
        {{ as_timestamp(states("sensor.date") + " " + states("sensor.prefer_" ~ day ~ "_lighting_mid")) | timestamp_custom("%-I:%M %p") }}
    dashboard_prefer_lighting_high:
      friendly_name: Prefer Lighting High Time
      entity_id:
        - sensor.prefer_weekday_lighting_high
        - sensor.prefer_weekend_lighting_high
      value_template: >-
        {% set day = "weekday" if now().strftime("%A")|lower in ["sunday", "monday", "tuesday", "wednesday", "thursday"] else "weekend" %}
        {{ as_timestamp(states("sensor.date") + " " + states("sensor.prefer_" ~ day ~ "_lighting_high")) | timestamp_custom("%-I:%M %p") }}


# Nest Sleep Mode Temperatures
- platform: template
  sensors:
    climate_downstairs_sleep_mode_cool:
      friendly_name: Downstairs Nest Sleep Mode - Cool
      value_template: 80
      unit_of_measurement: "ºF"
    climate_downstairs_sleep_mode_heat:
      friendly_name: Downstairs Nest Sleep Mode - Heat
      value_template: 76
      unit_of_measurement: "ºF"
    climate_upstairs_sleep_mode_cool:
      friendly_name: Upstairs Nest Sleep Mode - Cool
      value_template: 74
      unit_of_measurement: "ºF"
    climate_upstairs_sleep_mode_heat:
      friendly_name: Upstairs Nest Sleep Mode - Heat
      value_template: 74
      unit_of_measurement: "ºF"


# Nest Restore Modes
- platform: template
  sensors:
    climate_downstairs_restore_mode:
      friendly_name: Downstairs Nest Restore Mode
      entity_id: climate.downstairs
      value_template: >-
        {%- set previous_state = states('sensor.climate_downstairs_restore_mode') -%}
        {%- if not is_state('climate.downstairs', 'auto') -%}
          {{ states('climate.downstairs') }}
        {%- else -%}
          {{ previous_state }}
        {%- endif %}
    climate_upstairs_restore_mode:
      friendly_name: Upstairs Nest Restore Mode
      entity_id: climate.upstairs
      value_template: >-
        {%- set previous_state = states('sensor.climate_upstairs_restore_mode') -%}
        {%- if not is_state('climate.upstairs', 'auto') -%}
          {{ states('climate.upstairs') }}
        {%- else -%}
          {{ previous_state }}
        {%- endif %}


# Resident & Vehicle Sensors
- platform: template
  sensors:
    device_tracker_alex:
      friendly_name: Alex
      entity_id:
        - device_tracker.alexs_iphone_geofency
      value_template: >-
        {%- if is_state('device_tracker.alexs_iphone_geofency', 'not_home') -%}
          {{ state_attr('sensor.alex', 'city') }}
        {%- elif 'extended' in states('device_tracker.alexs_iphone_geofency') -%}
          {{ state_attr('sensor.alex', 'city') }}
        {%- else -%}
          {{ states('device_tracker.alexs_iphone_geofency') | replace("not_home", "away") | title }}
        {%- endif %}
      entity_picture_template: '/local/calvin.png'
    device_tracker_alex_recently_home:
      friendly_name: Alex - Recently Home
      entity_id: sensor.time
      value_template: >-
        {% if states('sensor.uptime') | int > 5 %}
          {% if is_state('device_tracker.alexs_iphone_geofency', 'home') and as_timestamp(now()) < (as_timestamp(states.device_tracker.alexs_iphone_geofency.last_changed) + (60 * 5)) %}
            on
          {% else %}
            off
          {% endif %}
        {% else %}
          off
        {% endif %}
    device_tracker_octavia:
      friendly_name: Octavia
      entity_id:
        - device_tracker.beacon_octavia
      value_template: >-
        {%- if is_state('device_tracker.beacon_octavia', 'not_home') -%}
          {{ state_attr('sensor.octavia', 'city') }}
        {%- elif 'extended' in states('device_tracker.beacon_octavia') -%}
          {{ state_attr('sensor.octavia', 'city') }}
        {%- else -%}
          {{ states('device_tracker.beacon_octavia') | replace("not_home", "away") | title }}
        {%- endif %}
      entity_picture_template: /local/jeep.png
    device_tracker_garage_actual_recently_closed:
      friendly_name: Garage - Recently Closed
      entity_id: sensor.time
      value_template: >-
        {% if states('sensor.uptime') | int > 5 %}
          {% if is_state('binary_sensor.garage_actual', 'off') and as_timestamp(now()) < (as_timestamp(states.binary_sensor.garage_actual.last_changed) + (60 * 5)) %}
            on
          {% else %}
            off
          {% endif %}
        {% else %}
          off
        {% endif %}


# Tautulli Sensors
- platform: template
  sensors:
    tautulli_count_transcode:
      friendly_name: Stream Count (Transcode)
      entity_id:
        - sensor.tautulli
      value_template: '{{ states.sensor.tautulli.attributes["stream_count_transcode"] }}'
    tautulli_direct_plays:
      friendly_name: Stream Count (Direct Play)
      entity_id:
        - sensor.tautulli
      value_template: '{{ states.sensor.tautulli.attributes["stream_count_direct_play"] }}'
    tautulli_direct_streams:
      friendly_name: Stream Count (Direct Stream)
      entity_id:
        - sensor.tautulli
      value_template: '{{ states.sensor.tautulli.attributes["stream_count_direct_stream"] }}'
    tautulli_total_streams:
      friendly_name: Stream Count
      entity_id:
        - sensor.tautulli
      value_template: '{{ states.sensor.tautulli.attributes["stream_count"] }}'
    tautulli_wan_bandwidth:
      friendly_name: WAN Bandwidth
      entity_id:
        - sensor.tautulli
      value_template: '{{ ((states.sensor.tautulli.attributes["wan_bandwidth"] / 1000) | round(1) | string).rstrip("0").rstrip(".") }}'
      unit_of_measurement: "Mbps"
    tautulli_lan_bandwidth:
      friendly_name: LAN Bandwidth
      entity_id:
        - sensor.tautulli
      value_template: '{{ ((states.sensor.tautulli.attributes["lan_bandwidth"] / 1000) | round(1) | string).rstrip("0").rstrip(".") }}'
      unit_of_measurement: "Mbps"
    tautulli_total_bandwidth:
      friendly_name: Total Bandwidth
      entity_id:
        - sensor.tautulli
      value_template: '{{ ((states.sensor.tautulli.attributes["total_bandwidth"] / 1000) | round(1) | string).rstrip("0").rstrip(".") }}'
      unit_of_measurement: "Mbps"
    # Tautulli User 1
    tautulli_user1:
      friendly_name: !secret tautulli_user1_friendly_name
      entity_id:
        - sensor.tautulli
      value_template: '{{ "off" if state_attr("sensor.tautulli", states("input_text.tautulli_user1")).Activity == none else state_attr("sensor.tautulli", states("input_text.tautulli_user1")).Activity | title }}'
      entity_picture_template: '{{ state_attr("sensor.tautulli", states("input_text.tautulli_user1")).user_thumb }}'
    # Tautulli User 2
    tautulli_user2:
      friendly_name: !secret tautulli_user2_friendly_name
      entity_id:
        - sensor.tautulli
      value_template: '{{ "off" if state_attr("sensor.tautulli", states("input_text.tautulli_user2")).Activity == none else state_attr("sensor.tautulli", states("input_text.tautulli_user2")).Activity | title }}'
      entity_picture_template: '{{ state_attr("sensor.tautulli", states("input_text.tautulli_user2")).user_thumb }}'
    # Tautulli User 3
    tautulli_user3:
      friendly_name: !secret tautulli_user3_friendly_name
      entity_id:
        - sensor.tautulli
      value_template: '{{ "off" if state_attr("sensor.tautulli", states("input_text.tautulli_user3")).Activity == none else state_attr("sensor.tautulli", states("input_text.tautulli_user3")).Activity | title }}'
      entity_picture_template: '{{ state_attr("sensor.tautulli", states("input_text.tautulli_user3")).user_thumb }}'
    # Tautulli User 4
    tautulli_user4:
      friendly_name: !secret tautulli_user4_friendly_name
      entity_id:
        - sensor.tautulli
      value_template: '{{ "off" if state_attr("sensor.tautulli", states("input_text.tautulli_user4")).Activity == none else state_attr("sensor.tautulli", states("input_text.tautulli_user4")).Activity | title }}'
      entity_picture_template: '{{ state_attr("sensor.tautulli", states("input_text.tautulli_user4")).user_thumb }}'
    # Tautulli User 5
    tautulli_user5:
      friendly_name: !secret tautulli_user5_friendly_name
      entity_id:
        - sensor.tautulli
      value_template: '{{ "off" if state_attr("sensor.tautulli", states("input_text.tautulli_user5")).Activity == none else state_attr("sensor.tautulli", states("input_text.tautulli_user5")).Activity | title }}'
      entity_picture_template: '{{ state_attr("sensor.tautulli", states("input_text.tautulli_user5")).user_thumb }}'
    # Tautulli User 6
    tautulli_user6:
      friendly_name: !secret tautulli_user6_friendly_name
      entity_id:
        - sensor.tautulli
      value_template: '{{ "off" if state_attr("sensor.tautulli", states("input_text.tautulli_user6")).Activity == none else state_attr("sensor.tautulli", states("input_text.tautulli_user6")).Activity | title }}'
      entity_picture_template: '{{ state_attr("sensor.tautulli", states("input_text.tautulli_user6")).user_thumb }}'
    # Tautulli User 7
    tautulli_user7:
      friendly_name: !secret tautulli_user7_friendly_name
      entity_id:
        - sensor.tautulli
      value_template: '{{ "off" if state_attr("sensor.tautulli", states("input_text.tautulli_user7")).Activity == none else state_attr("sensor.tautulli", states("input_text.tautulli_user7")).Activity | title }}'
      entity_picture_template: '{{ state_attr("sensor.tautulli", states("input_text.tautulli_user7")).user_thumb }}'
    # Tautulli User 8
    tautulli_user8:
      friendly_name: !secret tautulli_user8_friendly_name
      entity_id:
        - sensor.tautulli
      value_template: '{{ "off" if state_attr("sensor.tautulli", states("input_text.tautulli_user8")).Activity == none else state_attr("sensor.tautulli", states("input_text.tautulli_user8")).Activity | title }}'
      entity_picture_template: '{{ state_attr("sensor.tautulli", states("input_text.tautulli_user8")).user_thumb }}'
    # Tautulli User 9
    tautulli_user9:
      friendly_name: !secret tautulli_user9_friendly_name
      entity_id:
        - sensor.tautulli
      value_template: '{{ "off" if state_attr("sensor.tautulli", states("input_text.tautulli_user9")).Activity == none else state_attr("sensor.tautulli", states("input_text.tautulli_user9")).Activity | title }}'
      entity_picture_template: '{{ state_attr("sensor.tautulli", states("input_text.tautulli_user9")).user_thumb }}'

- platform: rest
  name: Tautulli Plex Update Available
  resource: !secret tautulli_plex_update
  value_template: '{{ "on" if value_json.response.data.update_available else "off" }}'
  scan_interval: 3600
- platform: rest
  name: Tautulli Plex Update Version
  resource: !secret tautulli_plex_update
  value_template: '{{ value_json.response.data.version }}'
  scan_interval: 3600




# InfluxDB Sensors
- platform: influxdb
  host: !secret influxdb_host
  port: !secret influxdb_port
  queries:
    # Overwatch Server
    - name: Overwatch CPU Load 1
      unit_of_measurement: '1 min'
      group_function: last
      where: '"host" = ''overwatch'' and time > now() - 5m'
      value_template: '{{ value | round(2) }}'
      measurement: '"system"'
      field: '"load1"'
      database: telegraf
    - name: Overwatch CPU Load 5
      unit_of_measurement: '5 min'
      group_function: last
      where: '"host" = ''overwatch'' and time > now() - 5m'
      value_template: '{{ value | round(2) }}'
      measurement: '"system"'
      field: '"load5"'
      database: telegraf
    - name: Overwatch CPU Load 15
      unit_of_measurement: '15 min'
      group_function: last
      where: '"host" = ''overwatch'' and time > now() - 5m'
      value_template: '{{ value | round(2) }}'
      measurement: '"system"'
      field: '"load15"'
      database: telegraf
    - name: Overwatch CPU Temp
      unit_of_measurement: 'ºC'
      group_function: last
      where: '"host" = ''overwatch'' and "chip" = ''coretemp-isa-0000'' and time > now() - 5m'
      value_template: '{{ value | round() }}'
      measurement: '"sensors"'
      field: '"temp_input"'
      database: telegraf
    - name: Overwatch RAM Used
      unit_of_measurement: '%'
      group_function: last
      where: '"host" = ''overwatch'' and time > now() - 5m'
      value_template: '{{ value | round() }}'
      measurement: '"mem"'
      field: '"used_percent"'
      database: telegraf
    # Woodhouse Server
    - name: Woodhouse CPU Load 1
      unit_of_measurement: '1 min'
      group_function: last
      where: '"host" = ''woodhouse'' and time > now() - 5m'
      value_template: '{{ value | round(2) }}'
      measurement: '"system"'
      field: '"load1"'
      database: telegraf
    - name: Woodhouse CPU Load 5
      unit_of_measurement: '5 min'
      group_function: last
      where: '"host" = ''woodhouse'' and time > now() - 5m'
      value_template: '{{ value | round(2) }}'
      measurement: '"system"'
      field: '"load5"'
      database: telegraf
    - name: Woodhouse CPU Load 15
      unit_of_measurement: '15 min'
      group_function: last
      where: '"host" = ''woodhouse'' and time > now() - 5m'
      value_template: '{{ value | round(2) }}'
      measurement: '"system"'
      field: '"load15"'
      database: telegraf
    - name: Woodhouse CPU1 Temp
      unit_of_measurement: 'ºC'
      group_function: last
      where: '"host" = ''woodhouse'' and "chip" = ''coretemp-isa-0000'' and time > now() - 5m'
      value_template: '{{ value | round() }}'
      measurement: '"sensors"'
      field: '"temp_input"'
      database: telegraf
    - name: Woodhouse CPU2 Temp
      unit_of_measurement: 'ºC'
      group_function: last
      where: '"host" = ''woodhouse'' and "chip" = ''coretemp-isa-0001'' and time > now() - 5m'
      value_template: '{{ value | round() }}'
      measurement: '"sensors"'
      field: '"temp_input"'
      database: telegraf
    - name: Woodhouse RAM Used
      unit_of_measurement: '%'
      group_function: last
      where: '"host" = ''woodhouse'' and time > now() - 5m'
      value_template: '{{ value | round() }}'
      measurement: '"mem"'
      field: '"used_percent"'
      database: telegraf
    # Overwatch Services
    - name: Service Status Home Assistant
      group_function: last
      where: !secret influxdb_service_status_home_assistant
      value_template: '{{ "Up" if value == "200" else "Down" }}'
      measurement: '"http_response"'
      field: '"http_response_code"'
      database: telegraf
    - name: Service Status Dashboard
      group_function: last
      where: !secret influxdb_service_status_dashboard
      value_template: '{{ "Up" if value == "200" else "Down" }}'
      measurement: '"http_response"'
      field: '"http_response_code"'
      database: telegraf
    # Woodhouse Services
    - name: Service Status Plex
      group_function: last
      where: !secret influxdb_service_status_plex
      value_template: '{{ "Up" if value == "200" else "Down" }}'
      measurement: '"http_response"'
      field: '"http_response_code"'
      database: telegraf
    - name: Service Status Sonarr
      group_function: last
      where: !secret influxdb_service_status_sonarr
      value_template: '{{ "Up" if value == "200" else "Down" }}'
      measurement: '"http_response"'
      field: '"http_response_code"'
      database: telegraf
    - name: Service Status SABnzbd
      group_function: last
      where: !secret influxdb_service_status_sabnzbd
      value_template: '{{ "Up" if value == "200" else "Down" }}'
      measurement: '"http_response"'
      field: '"http_response_code"'
      database: telegraf
    - name: Service Status Tautulli
      group_function: last
      where: !secret influxdb_service_status_tautulli
      value_template: '{{ "Up" if value == "200" else "Down" }}'
      measurement: '"http_response"'
      field: '"http_response_code"'
      database: telegraf
    - name: Service Status Grafana
      group_function: last
      where: !secret influxdb_service_status_grafana
      value_template: '{{ "Up" if value == "200" else "Down" }}'
      measurement: '"http_response"'
      field: '"http_response_code"'
      database: telegraf
    #UniFi
    - name: Service Status UniFi Network
      group_function: last
      where: !secret influxdb_service_status_unifi_network
      value_template: '{{ "Up" if value == "200" else "Down" }}'
      measurement: '"http_response"'
      field: '"http_response_code"'
      database: telegraf
    - name: Service Status UniFi Protect
      group_function: last
      where: !secret influxdb_service_status_unifi_protect
      value_template: '{{ "Up" if value == "200" else "Down" }}'
      measurement: '"http_response"'
      field: '"http_response_code"'
      database: telegraf
    #Network
    - name: Network Status Cox WAN
      group_function: last
      where: '"host" = ''woodhouse'' and time > now() - 5m'
      value_template: '{{ "Up" if value == "1" else "Down" }}'
      measurement: '"wan"'
      field: '"cox_wan"'
      database: telegraf
    - name: Network Status VPN WAN
      group_function: last
      where: '"host" = ''woodhouse'' and time > now() - 5m'
      value_template: '{{ "Up" if value == "1" else "Down" }}'
      measurement: '"wan"'
      field: '"vpn_wan"'
      database: telegraf
    - name: Network Status VPN2 WAN
      group_function: last
      where: '"host" = ''woodhouse'' and time > now() - 5m'
      value_template: '{{ "Up" if value == "1" else "Down" }}'
      measurement: '"wan"'
      field: '"vpn2_wan"'
      database: telegraf
    - name: Network Status VPN3 WAN
      group_function: last
      where: '"host" = ''woodhouse'' and time > now() - 5m'
      value_template: '{{ "Up" if value == "1" else "Down" }}'
      measurement: '"wan"'
      field: '"vpn3_wan"'
      database: telegraf
    - name: Network Status LAN
      group_function: last
      where: '"host" = ''woodhouse'' and time > now() - 5m'
      value_template: '{{ "Up" if value == "1" else "Down" }}'
      measurement: '"wan"'
      field: '"lan"'
      database: telegraf
    - name: Network Status VL40 IoT
      group_function: last
      where: '"host" = ''woodhouse'' and time > now() - 5m'
      value_template: '{{ "Up" if value == "1" else "Down" }}'
      measurement: '"wan"'
      field: '"vl40_iot"'
      database: telegraf
    - name: Network Status  VL50 Guest
      group_function: last
      where: '"host" = ''woodhouse'' and time > now() - 5m'
      value_template: '{{ "Up" if value == "1" else "Down" }}'
      measurement: '"wan"'
      field: '"vl50_guest"'
      database: telegraf


# States for Conditionals
- platform: template
  sensors:
    state_all_services_up:
      friendly_name: State - All Services Up
      entity_id:
        - sensor.service_status_home_assistant
        - sensor.service_status_dashboard
        - sensor.service_status_plex
        - sensor.service_status_sonarr
        - sensor.service_status_sabnzbd
        - sensor.service_status_tautulli
        - sensor.service_status_grafana
        - sensor.service_status_unifi_network
        - sensor.service_status_unifi_protect
      value_template: >-
        {% set services = [
          "sensor.service_status_home_assistant",
          "sensor.service_status_dashboard",
          "sensor.service_status_plex",
          "sensor.service_status_sonarr",
          "sensor.service_status_sabnzbd",
          "sensor.service_status_tautulli",
          "sensor.service_status_grafana",
          "sensor.service_status_unifi_network",
          "sensor.service_status_unifi_protect"
        ] %}

        {{ 'on' if states.sensor
          | selectattr('entity_id', 'in', services)
          | selectattr('state', 'eq', 'Down')
          | list
          | count == 0
          else 'off'
        }}
    state_all_vpn_wan_down:
      friendly_name: State - All VPN WANs Down
      entity_id:
        - sensor.network_status_vpn_wan
        - sensor.network_status_vpn2_wan
        - sensor.network_status_vpn3_wan
      value_template: >-
        {% set networks = [
          "sensor.network_status_vpn_wan",
          "sensor.network_status_vpn2_wan",
          "sensor.network_status_vpn3_wan",
        ] %}

        {{ 'on' if states.sensor
          | selectattr('entity_id', 'in', networks)
          | selectattr('state', 'eq', 'Down')
          | list
          | count == 3
          else 'off'
        }}
    state_ha_new_major_version:
      friendly_name: State - HA New Major Version
      entity_id:
        - sensor.current_version
        - sensor.latest_version
      value_template: >-
        {%- if states.sensor.current_version.state is defined and states.sensor.latest_version.state is defined -%}
          {{- "on" if states("sensor.latest_version").rsplit(".", 1)[0] > states("sensor.current_version").rsplit(".", 1)[0] else "off" -}}
        {%- else -%}
          unknown
        {%- endif %}


# Cox Data Usage
# - platform: file
#   name: Cox Data Plan
#   file_path: /config/json/cox_usage.json
#   value_template: >
#     {% if value_json is defined %}
#       {% if value_json.visitorLoginStatus == 'loggedin' %}
#         {{ value_json.lpInternetSubscribed }}
#       {% else %}
#         Update Error
#       {% endif %}
#     {% else %}
#       undefined
#     {% endif %}

# - platform: file
#   name: Cox Data Usage
#   file_path: /config/json/cox_usage.json
#   value_template: >
#     {% if value_json is defined %}
#       {% if value_json.visitorLoginStatus == 'loggedin' %}
#         {% if value_json.dumUsage | int == 0 and value_json.dumLimit | int == 0 and value_json.dumUtilization | int == 0 %}
#           {{ sensor.cox_data_usage }}
#         {% else %}
#           {{ value_json.dumUtilization | int }}
#         {% endif %}
#       {% else %}
#         unknown
#       {% endif %}
#     {% else %}
#       undefined
#     {% endif %}
#   unit_of_measurement: '%'

# - platform: file
#   name: Cox Data Usage - Long
#   file_path: /config/json/cox_usage.json
#   value_template: >
#     {% if value_json is defined %}
#       {% if value_json.dumUsage | int == 0 and value_json.dumLimit | int == 0 and value_json.dumUtilization | int == 0 %}
#        stats unavailable
#      {% else %}
#         {{ value_json.dumUsage | int }} / {{ value_json.dumLimit | int }} GB ({{ value_json.dumUtilization | int }} %)
#       {% endif %}
#     {% else %}
#       undefined
#     {% endif %}

# - platform: file
#   name: Cox Data Resets
#   file_path: /config/json/cox_usage.json
#   value_template: >
#     {% if value_json is defined %}
#       {% if value_json.visitorLoginStatus == 'loggedin' %}
#         {% if value_json.dumDaysLeft is defined %}
#           {{ value_json.dumDaysLeft | int }}
#         {% else %}
#           {{ sensor.cox_data_resets }}
#       {% endif %}
#       {% else %}
#         unknown
#       {% endif %}
#     {% else %}
#       undefined
#     {% endif %}
#   unit_of_measurement: 'days'


# suncalc data sensors
#   sunrise       - sunrise (top edge of the sun appears on the horizon)
#   sunriseEnd    - sunrise ends (bottom edge of the sun touches the horizon)
#   goldenHourEnd - morning golden hour (soft light, best time for photography) ends
#   solarNoon     - solar noon (sun is in the highest position)
#   goldenHour    - evening golden hour starts
#   sunsetStart   - sunset starts (bottom edge of the sun touches the horizon)
#   sunset        - sunset (sun disappears below the horizon, evening civil twilight starts)
#   dusk          - dusk (evening nautical twilight starts)
#   nauticalDusk  - nautical dusk (evening astronomical twilight starts)
#   night         - night starts (dark enough for astronomical observations)
#   nadir         - nadir (darkest moment of the night, sun is in the lowest position)
#   nightEnd      - night ends (morning astronomical twilight starts)
#   nauticalDawn  - nautical dawn (morning nautical twilight starts)
#   dawn          - dawn (morning nautical twilight ends, morning civil twilight starts)
#   HH:MM         - timestamp_custom('%H:%M')

# Used for "sun starts to rise" automations in the morning
- platform: file
  name: Suncalc sunriseEnd
  file_path: /config/json/suncalc_data.json
  value_template: >
    {% if value_json is defined %}
      {{ as_timestamp(value_json.sunriseEnd) | timestamp_custom('%H:%M') }}
    {% else %}
      undefined
    {% endif %}

# Used for "first light" automations in the morning
- platform: file
  name: Suncalc goldenHourEnd
  file_path: /config/json/suncalc_data.json
  value_template: >
    {% if value_json is defined %}
      {{ as_timestamp(value_json.goldenHourEnd) | timestamp_custom('%H:%M') }}
    {% else %}
      undefined
    {% endif %}

# Used for "sun starts setting" automations in the evening
- platform: file
  name: Suncalc goldenHour
  file_path: /config/json/suncalc_data.json
  value_template: >
    {% if value_json is defined %}
      {{ as_timestamp(value_json.goldenHour) | timestamp_custom('%H:%M') }}
    {% else %}
      undefined
    {% endif %}

# Used for "sun light is gone" automations in the evening
- platform: file
  name: Suncalc sunsetStart
  file_path: /config/json/suncalc_data.json
  value_template: >
    {% if value_json is defined %}
      {{ as_timestamp(value_json.sunsetStart) | timestamp_custom('%H:%M') }}
    {% else %}
      undefined
    {% endif %}

# Used for "night ends" automations in the morning
- platform: file
  name: Suncalc nightEnd
  file_path: /config/json/suncalc_data.json
  value_template: >
    {% if value_json is defined %}
      {{ as_timestamp(value_json.nightEnd) | timestamp_custom('%H:%M') }}
    {% else %}
      undefined
    {% endif %}

# Used for on screen display
- platform: file
  name: Golden Hour
  file_path: /config/json/suncalc_data.json
  value_template: >
    {% if value_json is defined %}
      {{ as_timestamp(value_json.goldenHour) | timestamp_custom('%-I:%M %p') }}
    {% else %}
      undefined
    {% endif %}

- platform: file
  name: First Light
  file_path: /config/json/suncalc_data.json
  value_template: >
    {% if value_json is defined %}
      {{ as_timestamp(value_json.sunriseEnd) | timestamp_custom('%-I:%M %p') }}
    {% else %}
      undefined
    {% endif %}

- platform: file
  name: First Light - Show
  file_path: /config/json/suncalc_data.json
  value_template: >
    {% if value_json is defined %}
      {% if as_timestamp(now()) | timestamp_custom("%H:%M") <= as_timestamp(value_json.sunriseEnd) | timestamp_custom("%H:%M") or as_timestamp(now()) | timestamp_custom("%H:%M") > as_timestamp(value_json.goldenHour) | timestamp_custom("%H:%M") %}
        on
      {% else %}
        off
      {% endif %}
    {% else %}
      off
    {% endif %}


# nut sensors
- platform: nut
  name: Server Rack UPS
  alias: rack
  username: !secret nut_username
  password: !secret nut_password
  resources:
    - battery.charge
    - battery.runtime
    - ups.status
    - ups.status.display
