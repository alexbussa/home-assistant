update_scene:
  alias: Update Scene
  sequence:
    - condition: template
      value_template: "{{ lights is defined }}"
    - service: script.turn_on
      data_template:
        entity_id: >
          {% set time                = as_timestamp(now()) | timestamp_custom("%H:%M") %}
          {% set sleep_mode          = is_state("input_boolean.trigger_sleep_mode", "on") %}
          {% set prefer_weekday_low  = states.sensor.prefer_weekday_lighting_low.state %}
          {% set prefer_weekday_mid  = states.sensor.prefer_weekday_lighting_mid.state %}
          {% set prefer_weekday_high = states.sensor.prefer_weekday_lighting_high.state %}
          {% set prefer_weekend_low  = states.sensor.prefer_weekend_lighting_low.state %}
          {% set prefer_weekend_mid  = states.sensor.prefer_weekend_lighting_mid.state %}
          {% set prefer_weekend_high = states.sensor.prefer_weekend_lighting_high.state %}

          {% set ht_lights = ["kitchen", "living_room", "tv_ambient", "rec_room_ambient"] %}

          {% set mode = '_night' if is_state('input_boolean.trigger_sunset_mode', 'on') or is_state('input_boolean.trigger_night_mode', 'on') else '_day' %}

          {% if is_state('input_boolean.trigger_home_theater_mode', 'on') %}
            {% if is_state('media_player.living_room_apple_tv', 'playing') %}
              {% set ht = "_ht_playing" %}
            {% else %}
              {% set ht = "_ht_on" %}
            {% endif %}
          {% else %}
            {% set ht = "" %}
          {% endif %}

          {% if is_state('input_boolean.trigger_night_mode', 'on') %}
            {% set weekday = ["sunday", "monday", "tuesday", "wednesday", "thursday"] %}
          {% else %}
            {% set weekday = ["monday", "tuesday", "wednesday", "thursday", "friday"] %}
          {% endif %}

          {% if now().strftime("%A")|lower in weekday %}
            {% if time >= prefer_weekday_low or (time <= prefer_weekday_high and sleep_mode) %}
              {% set brightness = "_low" %}
            {% elif time >= prefer_weekday_mid or time <= prefer_weekday_high %}
              {% set brightness = "_mid" %}
            {% else %}
              {% set brightness = "_mid" if trigger is defined else "_high" %}
            {% endif %}
          {% else %}
            {% if time >= prefer_weekend_low or (time <= prefer_weekend_high and sleep_mode) %}
              {% set brightness = "_low" %}
            {% elif time >= prefer_weekend_mid or time <= prefer_weekend_high %}
              {% set brightness = "_mid" %}
            {% else %}
              {% set brightness = "_mid" if trigger is defined else "_high" %}
            {% endif %}
          {% endif %}

          {% set list = lights.split(',') %}

          {% for light in list -%}
            script.scene_{{ light }}{{ mode if light == "tv_ambient" else mode | replace("sunset", "night") }}{{ ht if light in ht_lights }}{{ brightness if "_ambient" not in light }}
            {%- if not loop.last -%}
              ,
            {%- endif %}
          {%- endfor %}
