update_lights:
  alias: Update Lights
  icon: "mdi:lightbulb-on"
  mode: parallel
  sequence:
    - condition: template
      value_template: "{{ lights is defined }}"
    - service: script.turn_on
      data_template:
        entity_id: >
          {% set time                = as_timestamp(now()) | timestamp_custom("%H:%M") %}
          {% set sleep_mode          = is_state("input_boolean.mode_sleep", "on") %}
          {% set prefer_weekday_low  = states.sensor.prefer_weekday_lighting_low.state %}
          {% set prefer_weekday_mid  = states.sensor.prefer_weekday_lighting_mid.state %}
          {% set prefer_weekday_high = states.sensor.prefer_weekday_lighting_high.state %}
          {% set prefer_weekend_low  = states.sensor.prefer_weekend_lighting_low.state %}
          {% set prefer_weekend_mid  = states.sensor.prefer_weekend_lighting_mid.state %}
          {% set prefer_weekend_high = states.sensor.prefer_weekend_lighting_high.state %}

          {% set ht_lights = ["kitchen", "living_room", "living_room_tv", "rec_room_tiles"] %}
          {% set ambient_lights = ["living_room_tv", "rec_room_tiles", "bedroom_tiles", "den_cabinets"] %}

          {% set mode = '_night' if is_state('input_boolean.mode_sunset', 'on') else '_' + states('sensor.dashboard_current_home_mode') | lower %}

          {% if is_state('input_boolean.mode_home_theater', 'on') %}
            {% if is_state('media_player.living_room_apple_tv', 'playing') %}
              {% set ht = "_ht_playing" %}
            {% else %}
              {% set ht = "_ht_on" %}
            {% endif %}
          {% else %}
            {% set ht = "" %}
          {% endif %}

          {% if is_state('input_boolean.mode_night', 'on') %}
            {% set weekday = ["sunday", "monday", "tuesday", "wednesday", "thursday"] %}
          {% else %}
            {% set weekday = ["monday", "tuesday", "wednesday", "thursday", "friday"] %}
          {% endif %}

          {% if now().strftime("%A")|lower in weekday %}
            {% if time >= prefer_weekday_low or time <= prefer_weekday_high %}
              {% set brightness = "_low" %}
            {% elif time >= prefer_weekday_mid or time <= prefer_weekday_high %}
              {% set brightness = "_mid" %}
            {% else %}
              {% set brightness = "_mid" if trigger is defined else "_high" %}
            {% endif %}
          {% else %}
            {% if time >= prefer_weekend_low or time <= prefer_weekend_high %}
              {% set brightness = "_low" %}
            {% elif time >= prefer_weekend_mid or time <= prefer_weekend_high %}
              {% set brightness = "_mid" %}
            {% else %}
              {% set brightness = "_mid" if trigger is defined else "_high" %}
            {% endif %}
          {% endif %}

          {% set list = lights.split(',') %}

          {% for light in list -%}
            script.scene_{{ light }}{{ mode }}{{ ht if light in ht_lights }}{{ brightness if light not in ambient_lights }}
            {%- if not loop.last -%}
              ,
            {%- endif %}
          {%- endfor %}
